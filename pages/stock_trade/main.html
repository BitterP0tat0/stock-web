<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Finnhub WS Client with Bootstrap</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body class="p-4">

  <h1>Finnhub WebSocket Test</h1>
  <div class="mb-3">
    <button id="subscribeBtn" class="btn btn-primary me-2">Subscribe AAPL</button>
    <button id="unsubscribeBtn" class="btn btn-danger">Unsubscribe AAPL</button>
  </div>

  <pre id="log" class="bg-light p-3 border rounded" style="height: 150px; overflow-y: auto;"></pre>

  <div id="tradeTableContainer" class="mt-4"></div>

<script>
  const socket = io('http://localhost:8080/finnhub', {
    transports: ['websocket'],
  });

  const logEl = document.getElementById('log');
  const tradeTableContainer = document.getElementById('tradeTableContainer');

  function log(msg) {
    logEl.textContent += msg + '\n';
    logEl.scrollTop = logEl.scrollHeight;
    console.log(msg);
  }

  const latestTradesBySymbol = {};

  function renderTradesTable() {
    const symbols = Object.keys(latestTradesBySymbol);
    if (symbols.length === 0) {
      tradeTableContainer.innerHTML = '<p class="text-muted">No trades to display.</p>';
      return;
    }

    let rowsHtml = symbols.map(symbol => {
      const trade = latestTradesBySymbol[symbol];
      const date = new Date(trade.t);
      const dateStr = date.toLocaleString();

      return `
        <tr>
          <td>${symbol}</td>
          <td>${trade.p}</td>
          <td>${dateStr}</td>
          <td>${trade.v}</td>
        </tr>
      `;
    }).join('');

    const tableHtml = `
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Symbol</th>
            <th>Price</th>
            <th>Time</th>
            <th>Volume</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    `;

    tradeTableContainer.innerHTML = tableHtml;
  }

  socket.on('connect', () => {
    log(`Connected with socket id: ${socket.id}`);
  });

  socket.on('disconnect', () => {
    log('Disconnected from server');
  });

  socket.on('trades', (data) => {
    log(`Received trades: ${JSON.stringify(data)}`);

    data.forEach(trade => {
      latestTradesBySymbol[trade.s] = trade;
    });

    renderTradesTable();
  });

  socket.on('finnhub-message', (data) => {
    log(`Received raw Finnhub message: ${JSON.stringify(data)}`);
  });

  document.getElementById('subscribeBtn').onclick = () => {
    socket.emit('subscribe', { symbol: 'AAPL' });
    log('Sent subscribe for AAPL');
  };

  document.getElementById('unsubscribeBtn').onclick = () => {
    socket.emit('unsubscribe', { symbol: 'AAPL' });
    log('Sent unsubscribe for AAPL');
  };
</script>

</body>
</html>
