<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Finnhub WS Client with Bootstrap</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../../css/stock_trade.css" />

  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body class="p-4 display-flex flex-column min-vh-100">


 <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">Finance</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="./login.html">My Account</a>
              
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="./login.html">Premium</a>
              
            </li>
            <button id="mode-toggle" class="btn btn-outline-secondary ms-2">
              Dark Mode
            </button>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-4">
      <h1 class="text-center mb-4">Your balance</h1>
      <p class="text-center text-muted">Real-time trades from Finnhub WebSocket API</p>
    </div>
  <div id="tradeTableContainer" class="mt-4"></div>
<div id="pagination" class="mt-3"></div> 
  <script>
    const socket = io('http://localhost:8080/finnhub', {
      transports: ['websocket'],
    });

   const tradeTableContainer = document.getElementById('tradeTableContainer');
const paginationContainer = document.getElementById('pagination');
const latestTradesBySymbol = {}; 

let currentPage = 1;
const itemsPerPage = 10;

function renderTradesTable() {
  const symbols = Object.keys(latestTradesBySymbol);
  if (symbols.length === 0) {
    tradeTableContainer.innerHTML = '<p class="text-muted">No trades to display.</p>';
    paginationContainer.innerHTML = '';
    return;
  }

  const tradesArray = symbols.map(symbol => latestTradesBySymbol[symbol]);
  
  const totalPages = Math.ceil(tradesArray.length / itemsPerPage);
  if (currentPage > totalPages) currentPage = totalPages; 
  if (currentPage < 1) currentPage = 1;

  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageTrades = tradesArray.slice(startIndex, endIndex);

  const rowsHtml = pageTrades.map(trade => {
    const date = new Date(trade.t);
    const dateStr = date.toLocaleString();

    return `
      <tr>
        <td>${trade.s}</td>
        <td>$${trade.p}</td>
        <td>${dateStr}</td>
        <td>${trade.v}</td>
      </tr>
    `;
  }).join('');

  const tableHtml = `
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Symbol</th>
          <th>Price</th>
          <th>Time</th>
          <th>Volume</th>
        </tr>
      </thead>
      <tbody>
        ${rowsHtml}
      </tbody>
    </table>
  `;

  tradeTableContainer.innerHTML = tableHtml;

  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  if (totalPages <= 1) {
    paginationContainer.innerHTML = '';
    return;
  }

  let buttonsHtml = '';

  buttonsHtml += `<button class="btn btn-sm btn-primary me-2" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Previous</button>`;

  const maxButtons = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
  let endPage = startPage + maxButtons - 1;
  if (endPage > totalPages) {
    endPage = totalPages;
    startPage = Math.max(1, endPage - maxButtons + 1);
  }

  for (let i = startPage; i <= endPage; i++) {
    buttonsHtml += `<button class="btn btn-sm me-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}" onclick="goToPage(${i})">${i}</button>`;
  }

  buttonsHtml += `<button class="btn btn-sm btn-primary ms-2" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>`;

  paginationContainer.innerHTML = buttonsHtml;
}

function goToPage(page) {
  currentPage = page;
  renderTradesTable();
}

socket.on('trades', (data) => {
  data.forEach(trade => {
    latestTradesBySymbol[trade.s] = trade;
  });
  renderTradesTable();
});

  </script>
  <script src="../../scripts/Navigationbar/Navigation.js"></script>

</body>
</html>
